# 简介

## 更新次序
1. 一般最先在`ida`进行详细的反编码。所以所有结构都最先保存在[idb文件](./DLZ.exe.idb)（但是也有可能是错误的）
2. 一旦觉得没有问题，就会更新至010editor的[模板文件](../template/)。再次验证数据是否正确
3. 上一步确认没有问题后，将会更新至[脚本代码](../scripts/)

## 工具
* UltraEdit 二进制与文本切换起来非常方便
* 010editor v12.0.1 二进制文件结构化分析功能十分强大
* Ida v7.7  反汇编逆向工具
* Mspaint   分析调色板

## 模板说明
* bt后缀文件，需要010editor，相关文件保存位置在[这里](../template/)
* py后缀文件，需要python 3.10，以及pillow库。相关脚本保存在[这里](../scripts/)
* ida.exe，神级逆向工具

## 调色板
通过分析数据和游戏运行截图，从而推到相关图片的调色板。依然未发现调色板数据的保存位置。
当前的分析结果可以查看这个[文件](../scripts/export_utils.py)

# 技能
技能所在文件`game.dat`，一共`16`个技能，每个技能的长度为`0x30` `48`。

在运行文件中：
地址`00447280`保存的是当前使用的技能索引
地址`0057BA40`保存的是技能数据，即`game.dat`中的技能数据

## 列表
| 序号 | 名称 | 地址 | 长度 | 参数1 | 参数2 | 类型 | 选择范围 | 应用范围 | 大动画 | 小动画 | 声音 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
|0|补给|x0743c|x030|120|0|x0 增加体力|5|40|-1|16|602|
|1|激励|x0746c|x030|0|20|x1 增加士气|5|40|-1|17|618|
|2|医疗|x0749c|x030|120|10|x2 增加体力士气|5|40|-1|18|635|
|3|火攻|x074cc|x030|80|0|x3 降低体力|2|44|0|0|610|
|4|滚木|x074fc|x030|80|0|x3 降低体力|2|44|1|1|611|
|5|擂石|x0752c|x030|80|0|x3 降低体力|2|44|2|2|613|
|6|威慑|x0755c|x030|0|20|x4 降低士气|4|40|-1|27|620|
|7|骚扰|x0758c|x030|50|0|x5 防御-70%|5|40|-1|19|605|
|8|破坏|x075bc|x030|50|0|x6 攻击-70%|5|40|-1|20|624|
|9|掠夺|x075ec|x030|0|0|x7 抢夺装备|5|0|-1|21|627|
|10|反间|x0761c|x030|0|0|x8 攻击等级-1|5|40|-1|31|636|
|11|疑兵|x0764c|x030|0|0|x9 停止攻击一回合|5|40|-1|23|612|
|12|督战|x0767c|x030|20|0|xa 恢复攻击|5|16|-1|24|637|
|13|暗杀|x076ac|x030|10000|0|x3 降低体力|4|0|-1|25|638|
|14|施毒|x076dc|x030|180|40|x3 降低体力|5|40|3|3|639|
|15|空袭|x0770c|x030|400|0|x3 降低体力|15|36|4|4|600|

## 技能等级判定
游戏保存各个技能使用的次数（包括攻击），然后按照使用次数来定义技能等级。每个技能等级所需要的的次数是
| 等级 | 次数上限 |
| :-: | ---: |
| 0 | 1 |
| 1 | 10 |
| 2 | 25 |
| 3 | 45 |
| 4 | 70 |
| 5 | 100 |
| 6 | 135 |
| 7 | 175 |
| 8 | 225 |
| 9 | 300 |
| 10| --- |

数据地址：`00447280`

## 公式
### 伤害
以下公式都是ida逆向分析结果，汇编码在`text:00413909`位置附近。如果你不想研究汇编代码，也可以到[这里](../template/dlz_game.bt)查看，进一步了解更多信息。
1. 公式一 
``` c
formula1 = people_zhili * game_jineng_para1 / 0x64u;
formula1 = (jineng_level + 7) * formula1 >> 3;
```

2. 公式二
``` c
formula2 = people_zhili * game_jineng_para2 / 0x64u;
formula2 = (jineng_level + 7) * formula2 >> 3;
```

## 经验
函数地址`004138EA`

### 补给
* 自己人回血最低2经验，最高4经验。比例是回的血（到顶了，浪费了）与可以回血之比。
* 友军人回血最低4经验，最高8经验。和自己人回血经验相比，经验翻倍。
* 每成功给一个人回血(>0)，使用次数`+1`。同时给`N`个人回血成功，使用次数`+N`

**主角和柳忻相互之间回血，会影响结局**
**同理肖飞和柳忻之间回血，也会影响结局**

### 激励
* 自己人回士气最低1经验，最高4经验。比例是回的士气（到顶了，浪费了）与可以回的士气之比。
* 友军人回士气最低4经验，最高12经验。和自己人回士气经验相比，经验翻两倍。
* 每成功给一个人回士气(>0)，使用次数`+1`。同时给`N`个人回士气成功，使用次数`+N`

**主角和柳忻相互之间士气，会影响结局**
**同理肖飞和柳忻之间士气，也会影响结局**

### 激励
* 自己人2经验
* 友军人8经验
* 每成功给一个人回血**或者**回士气(>0)，使用次数`+1`。同时给`N`个人回血**或者**回士气成功，使用次数`+N`

**主角和柳忻相互之间激励，会影响结局**
**同理肖飞和柳忻之间激励，也会影响结局**

# 人物
一共128个人物，40个我方人物，其中32个可加入（包括主角）。人物有两个结构体描述，一个为People, 大小为`84h`字节；另一个为Fighter，大小为`40h`字节。People在执行文件的地址是`007D0EF8`；Fighter的地址是`0096AB90`。
## 公式
* 地址`0042A82A`, 攻击力 = $(武力+500)*\frac{(人物等级-1)*(兵种攻击力加成-1)+\frac{武力*3*兵种攻击力}{100}}{580}*\frac{技能等级+59}{60}*装备完整度*\frac{士气+100}{200} + 物品攻击力$
* 地址`0042A98E`，防御力 = $((人物等级-1)*兵种防御力加成+兵种防御力)*\frac{what?}{100}*\frac{士气+100}{200}*\frac{100+地形修正}{100}+物品防御力$
* 伤害 = $(攻击力-防御力)*\frac{应用范围修正}{100}$
* 士气 = $MAX(1,\frac{20*伤害}{体力})$

##### 计分
##### 成功率
##### 升级
##### 战斗策略
战斗策略通过硬编码实现，每个战斗策略又通过若干的行为构成。敌方、友方、自动战斗部分都由战斗策略来完成。
有函数`get_fighter_behavior`和`calc_behavior`来实现。

#### 逆向工程文件
DLZ.exe.idb是是对`dlz.exe`的逆向工程的打包文件。其对应的版本是`IDA pro 7.7 32bit`。现决定将其备份至gitee（这个文件不会频繁更新）。以待有人需要它。

#### 相关资料页面
#####窗口消息
[窗口消息列表](https://wiki.winehq.org/List_Of_Windows_Messages)
[virtual-key代码](https://docs.microsoft.com/zh-cn/windows/win32/inputdev/virtual-key-codes)
##### mci列表
[定义列表](http://www.gaclib.net/CodeIndexDemo/Gaclib/SourceFiles/mciapi.h.html)