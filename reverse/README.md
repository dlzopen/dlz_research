# 简介

## 更新次序
1. 一般最先在`ida`进行详细的反编码。所以所有结构都最先保存在[idb文件](./DLZ.exe.idb)（但是也有可能是错误的）
2. 一旦觉得没有问题，就会更新至010editor的[模板文件](../template/)。再次验证数据是否正确
3. 上一步确认没有问题后，将会更新至[脚本代码](../scripts/)

## 工具
* UltraEdit 二进制与文本切换起来非常方便
* 010editor v12.0.1 二进制文件结构化分析功能十分强大
* Ida v7.7  反汇编逆向工具
* Mspaint   分析调色板

## 模板说明
* bt后缀文件，需要010editor，相关文件保存位置在[这里](../template/)
* py后缀文件，需要python 3.10，以及pillow库。相关脚本保存在[这里](../scripts/)
* ida.exe，神级逆向工具

## 调色板
通过分析数据和游戏运行截图，从而推到相关图片的调色板。依然未发现调色板数据的保存位置。
当前的分析结果可以查看这个[文件](../scripts/export_utils.py)

# 技能
技能所在文件`game.dat`，一共`16`个技能，每个技能的长度为`0x30` `48`。

在运行文件中：
地址`00447280`保存的是当前使用的技能索引
地址`0057BA40`保存的是技能数据，即`game.dat`中的技能数据

## 列表
| 序号 | 名称 | 地址 | 长度 | 参数1 | 参数2 | 类型 | 选择范围 | 应用范围 | 大动画 | 小动画 | 声音 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
|0|补给|x0743c|x030|120|0|x0 增加体力|5|40|-1|16|602|
|1|激励|x0746c|x030|0|20|x1 增加士气|5|40|-1|17|618|
|2|医疗|x0749c|x030|120|10|x2 增加体力士气|5|40|-1|18|635|
|3|火攻|x074cc|x030|80|0|x3 降低体力|2|44|0|0|610|
|4|滚木|x074fc|x030|80|0|x3 降低体力|2|44|1|1|611|
|5|擂石|x0752c|x030|80|0|x3 降低体力|2|44|2|2|613|
|6|威慑|x0755c|x030|0|20|x4 降低士气|4|40|-1|27|620|
|7|骚扰|x0758c|x030|50|0|x5 防御-70%|5|40|-1|19|605|
|8|破坏|x075bc|x030|50|0|x6 攻击-70%|5|40|-1|20|624|
|9|掠夺|x075ec|x030|0|0|x7 抢夺装备|5|0|-1|21|627|
|10|反间|x0761c|x030|0|0|x8 攻击等级-1|5|40|-1|31|636|
|11|疑兵|x0764c|x030|0|0|x9 停止攻击一回合|5|40|-1|23|612|
|12|督战|x0767c|x030|20|0|xa 恢复攻击|5|16|-1|24|637|
|13|暗杀|x076ac|x030|10000|0|x3 降低体力|4|0|-1|25|638|
|14|施毒|x076dc|x030|180|40|x3 降低体力|5|40|3|3|639|
|15|空袭|x0770c|x030|400|0|x3 降低体力|15|36|4|4|600|

## 技能等级
游戏保存各个技能使用的次数（包括攻击），然后按照使用次数来定义技能等级。每个技能等级所需要的的次数是
| 等级 | 次数上限 |
| :-: | ---: |
| 0 | 1 |
| 1 | 10 |
| 2 | 25 |
| 3 | 45 |
| 4 | 70 |
| 5 | 100 |
| 6 | 135 |
| 7 | 175 |
| 8 | 225 |
| 9 | 300 |
| 10| --- |

数据地址：`00447280`

## 公式
### 伤害
以下公式都是ida逆向分析结果，汇编码在`text:00413909`位置附近。如果你不想研究汇编代码，也可以到[这里](../template/dlz_game.bt)查看，进一步了解更多信息。
* 公式一  $\dfrac{智力 \times 技能参数1}{100} \times (技能等级 + 7) >> 3$
* 公式二  $\dfrac{智力 \times 技能参数2}{100} \times (技能等级 + 7) >> 3$
* 修正 $公式结果\times\dfrac{应用范围修正}{100}$

## 经验
函数地址`004138EA`

### 补给
* 自己人回血最低2经验，最高4经验。比例是回的血（到顶了，浪费了）与可以回血之比。
* 友军人回血最低4经验，最高8经验。和自己人回血经验相比，经验翻倍。
* 每成功给一个人回血(>0)，使用次数`+1`。同时给`N`个人回血成功，使用次数`+N`

**主角和柳忻相互之间回血，会影响结局**
**同理肖飞和柳忻之间回血，也会影响结局**

### 激励
* 自己人回士气最低1经验，最高4经验。比例是回的士气（到顶了，浪费了）与可以回的士气之比。
* 友军人回士气最低4经验，最高12经验。和自己人回士气经验相比，经验翻两倍。
* 每成功给一个人回士气(>0)，使用次数`+1`。同时给`N`个人回士气成功，使用次数`+N`

**主角和柳忻相互之间回士气，会影响结局**
**同理肖飞和柳忻之间回士气，也会影响结局**

### 医疗
* 自己人2经验
* 友军人8经验
* 每成功给一个人回血**或者**回士气(>0)，使用次数`+1`。同时给`N`个人回血**或者**回士气成功，使用次数`+N`

**主角和柳忻相互之间激励，会影响结局**
**同理肖飞和柳忻之间激励，也会影响结局**

# 地图
塔图文件（DLZ称之为BLK）有16张。塔图大小为48*48。每张塔图的图片数量上限为4096。分为16种地形。游戏总共有47张地图。
## 地图数据
| 序号 | 名称 | 宽度 | 高度 | 塔图索引 | 缩略图 |
| :-- | --- | --: | --: | --: | :-: |
| 0 | 穿越封锁线 | 20  | 26  | 11 | ![](../imgs/map/00.png) |
| 1 | 营救朱老忠 | 26  | 30  | 2 | ![](../imgs/map/01.png) |
| 2 | 攻打赵村 | 24  | 28  | 11 | ![](../imgs/map/02.png) |
| 3 | 接应李向阳 | 25  | 31  | 11 | ![](../imgs/map/03.png) |
| 4 | 处决高敬天 | 20  | 24  | 2 | ![](../imgs/map/04.png) |
| 5 | 攻打李村 | 24  | 28  | 11 | ![](../imgs/map/05.png) |
| 6 | 接应肖飞 | 29  | 36  | 11 | ![](../imgs/map/06.png) |
| 7 | 攻占土桥 | 32  | 37  | 4 | ![](../imgs/map/07.png) |
| 8 | 救援白洋淀 | 32  | 36  | 11 | ![](../imgs/map/08.png) |
| 9 | 保卫白洋淀 | 30  | 40  | 11 | ![](../imgs/map/09.png) |
| 10 | 智救村民 | 33  | 38  | 5 | ![](../imgs/map/10.png) |
| 11 | 解救林嫂 | 33  | 38  | 5 | ![](../imgs/map/11.png) |
| 12 | 抢夺粮食 | 26  | 38  | 7 | ![](../imgs/map/12.png) |
| 13 | 保卫冉庄 | 26  | 38  | 7 | ![](../imgs/map/13.png) |
| 14 | 地道战 | 65  | 10  | 1 | ![](../imgs/map/14.png) |
| 15 | 打火车 | 40  | 35  | 6 | ![](../imgs/map/15.png) |
| 16 | 过铁路 | 40  | 35  | 6 | ![](../imgs/map/16.png) |
| 17 | 夺取武器 | 65  | 10  | 3 | ![](../imgs/map/17.png) |
| 18 | 智擒郑之光 | 38  | 42  | 2 | ![](../imgs/map/18.png) |
| 19 | 义收金花婆 | 22  | 28  | 11 | ![](../imgs/map/19.png) |
| 20 | 增援鸡公山 | 40  | 35  | 11 | ![](../imgs/map/20.png) |
| 21 | 除掉高得远 | 40  | 36  | 2 | ![](../imgs/map/21.png) |
| 22 | 攻打黑风寨 | 18  | 51  | 11 | ![](../imgs/map/22.png) |
| 23 | 营救彼德 | 29  | 36  | 11 | ![](../imgs/map/23.png) |
| 24 | 攻打长湾 | 26  | 30  | 2 | ![](../imgs/map/24.png) |
| 25 | 攻打施南镇 | 33  | 38  | 9 | ![](../imgs/map/25.png) |
| 26 | 孤胆英雄 | 18  | 40  | 0 | ![](../imgs/map/26.png) |
| 27 | 施南保卫战 | 35  | 40  | 9 | ![](../imgs/map/27.png) |
| 28 | 保卫红岩寺 | 24  | 43  | 11 | ![](../imgs/map/28.png) |
| 29 | 刺杀川岛芳子 | 48  | 38  | 11 | ![](../imgs/map/29.png) |
| 30 | 红岩反击战 | 36  | 50  | 2 | ![](../imgs/map/30.png) |
| 31 | 夹击桥本 | 35  | 32  | 9 | ![](../imgs/map/31.png) |
| 32 | 袭击军火库 | 42  | 40  | 14 | ![](../imgs/map/32.png) |
| 33 | 袭击军营 | 40  | 48  | 9 | ![](../imgs/map/33.png) |
| 34 | 攻打县城 | 48  | 56  | 9 | ![](../imgs/map/34.png) |
| 35 | 大决战 | 36  | 48  | 9 | ![](../imgs/map/35.png) |
| 36 | 狼牙山狙击战 | 18  | 60  | 13 | ![](../imgs/map/36.png) |
| 37 | 平型关大战 | 60  | 24  | 12 | ![](../imgs/map/37.png) |
| 38 | 台儿庄大战 | 40  | 56  | 9 | ![](../imgs/map/38.png) |
| 39 | 昆仑关反击战 | 40  | 56  | 15 | ![](../imgs/map/39.png) |
| 40 | 狼牙山狙击战 | 18  | 60  | 13 | ![](../imgs/map/36.png) |
| 41 | 平型关大战 | 60  | 24  | 12 | ![](../imgs/map/37.png) |
| 42 | 台儿庄大战 | 40  | 56  | 9 | ![](../imgs/map/38.png) |
| 43 | 昆仑关反击战 | 40  | 56  | 15 | ![](../imgs/map/39.png) |
| 44 | 中国象棋 | 33  | 36  | 11 | ![](../imgs/map/44.png) |
| 45 | 龟兔赛跑 | 36  | 50  | 2 | ![](../imgs/map/45.png) |
| 46 | 鬼子进村 | 28  | 15  | 11 | ![](../imgs/map/46.png) |

# 人物
一共128个人物，40个我方人物，其中32个可加入（包括主角）。人物有两个结构体描述，一个为People, 大小为`84h`字节；另一个为Fighter，大小为`40h`字节。People在执行文件的地址是`007D0EF8`；Fighter的地址是`0096AB90`。
## 公式
* 地址`0042A82A`, 攻击力 = $$(武力 + 500)\times\dfrac{(人物等级-1)\times(兵种攻击力加成-1)+\dfrac{武力\times 3 \times兵种攻击力}{100}}{580}\times\dfrac{技能等级+59}{60}\times 装备完整度 \times \dfrac{士气+100}{200} + 物品攻击力$$
* 地址`0042A98E`，防御力 = $$((人物等级 - 1)\times兵种防御力加成+兵种防御力)\times\frac{what?}{100}\times\frac{士气+100}{200}\times\frac{100+地形修正}{100}+物品防御力$$
* 伤害 = $(攻击力-防御力)\times\frac{应用范围修正}{100}$
* 士气 = $MAX(1,\frac{20 \times 伤害}{体力})$

##### 计分
##### 成功率
##### 升级
##### 战斗策略
战斗策略通过硬编码实现，每个战斗策略又通过若干的行为构成。敌方、友方、自动战斗部分都由战斗策略来完成。
有函数`get_fighter_behavior`和`calc_behavior`来实现。

#### 逆向工程文件
DLZ.exe.idb是是对`dlz.exe`的逆向工程的打包文件。其对应的版本是`IDA pro 7.7 32bit`。现决定将其备份至gitee（这个文件不会频繁更新）。以待有人需要它。

#### 相关资料页面
#####窗口消息
[窗口消息列表](https://wiki.winehq.org/List_Of_Windows_Messages)
[virtual-key代码](https://docs.microsoft.com/zh-cn/windows/win32/inputdev/virtual-key-codes)
##### mci列表
[定义列表](http://www.gaclib.net/CodeIndexDemo/Gaclib/SourceFiles/mciapi.h.html)
